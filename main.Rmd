---
title: "pilot"
author: "REACH BGD"
date: "2 July 2019"
output:
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE, warning = FALSE, message=FALSE}

group<-c("host","refugee")[1]

knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warning = FALSE)
library(dplyr)
library(hypegrammaR)
library(kableExtra)
library(msni19)
library(glue)
library(ggmosaic)

source("functions/utilities.R")
source("functions/loading_inputs.R")
source("functions/severity_recoding_from_combination_table.R")
source("functions/severity_recoding_host.R")
source("functions/severity_recoding_refugee.R")
source("functions/plots.R")
source("./functions/sensitivity_utilities.R")
source("./functions/sensitivity_indicator_inclusion.R")

#  READ INPUT FILES

assessment<-msna18_severity_pilot_load_assessment(group)

if(group=="host") severity_compositions <- host_severity_bgd_msna18
if(group == "refugee") severity_compositions <- refugee_severity_bgd_msna18


assessment$data %<>% remove_non_consent

assessment$severity <- severity_compositions(hh  = assessment$data,
                                             ind = assessment$loops$individuals)

if(group == "refugee"){
combination_tables<-read_all_csvs("./input_public/threshold_definitions/refugees/")  
}else{
  combination_tables<-read_all_csvs("./input_public/threshold_definitions/host/")  

}

subpillar_scores <- subpillar_scores_bgd(list_of_combination_tables = combination_tables,
                                                       data = assessment$severity)




assessment$severity <- c(assessment$severity,subpillar_scores) %>% as_tibble

# impact & capacity score guessed
assessment$severity$impact <- 4

# msni not existent yet so randomising
assessment$data$msni<-with(assessment$severity,{
  msni19::msni(education_lsg = edu, 
               fsl_lsg = fsl, 
               health_lsg = health,
               protection_lsg = protection,
               wash_lsg = wash,
               shelter_lsg = shelter,
               impact = impact,
               capacity_gaps = capacity)
})


# everything below happening inside "assessment", so attaching for brevity:
attach(assessment)


  
```



# Severity Scoring Pilot `r ifelse(group=="host","Host Community", "Refugees")`

## Summary

### Results by Union

Distribution of severity:

```{r,fig.height = 20,fig.width = 5}

faceted_density_plot(assessment$data,
                     x_variable_name = "msni",
                     default_disaggregation)

```

The estimated severity in the host community:





```{r}
type_of_analysis<-map_to_case("group_difference",
                  dependent.var.type = "categorical",
                  independent.var.type = "categorical")


severity_disaggregated <- map_to_result(data,dependent.var = "msni",
                                        independent.var = default_disaggregation,
                                        case = type_of_analysis,
                                        weighting = weighting)

severity_disaggregated %>%
  map_to_labeled(questionnaire) %>% 
  map_to_table %>% kable %>% kable_styling()

```


```{r,fig.height=10}



severity_disaggregated %>%
  (function(x){x$summary.statistic<-x$summary.statistic %>% arrange(independent.var.value,numbers);x}) %>% 
  map_to_labeled(questionnaire) %>% (hypegrammaR:::grouped_barchart_percent) %>% .$ggplot + coord_flip()+ylab("% population per MSNI score")



```


### Distribution - How 'varied' are the scores?
```{r}

design<-map_to_design(data,weighting_function =  weighting)
standard_deviation <- sqrt(survey::svyvar(~msni,design)[1])
```
The overall standard deviation was <b> `r standard_deviation` </b>

```{r}
ecdf <- weighted_ecdf(data$msni, weighting(data))

ggplot(ecdf, aes(x, cum.pct)) +
  geom_line() + 
  theme_minimal() + 
  ylab("Cummulative probability") + 
  xlab("Score")

```

## Results

## Methodology


## Sensitivity and Robustness

Missing values in composite indicators
```{r}

percent_na_sev<-severity[,-1] %>% lapply(percent_na) %>% unlist
data.frame(`composite variable` = names(severity[,-1]),
           `percent NA` = percent_na_sev,
           check.names = FALSE) %>%
  kable %>%
  kable_styling()
```


### Sensitivity to Included Indicators


```{r}
# create variations and calculate msni
msni_varied_indicators<-msni_variations(combination_tables, 
                                        assessment$severity,
                                        variation_function = vary_combination_tables_indicator_inclusion)

```
We show that overall, the index is not overly affected by removing (and by extension adding) individual indicators from the calculation, with the exception of three indicators whos importance warrants a stronger impact.

We test how sensitive the index is with regards to which indicators are included; The overall score should ideally not be completely changed if specific indicators are added or removed; at the same time we should expect at least some variation based on which indicators are included. Prior to analysis, we choose a threshold of **a difference of 0.5 on the 1-4 scale that should ideally not be surpassed** if an individual indicator is removed (or added). We recalculate the score after removing each of the `r ncol(msni_varied_indicators)` sub-indicators , and test for each one whether the difference to the complete index exceeds 0.5

```{r}

# t-test: differences smaller 0.5 on average?

# new dataframe: differences & stratum 

msni_original<- tibble(msni = assessment$data$msni)


sensitivity_test_table<- sensitivity_variation_test_result_table(msni_original = msni_original,
                                        msni_varied = msni_varied_indicators,
                                        threshold = 0.5,
                                        strata_data_name = default_disaggregation,
                                        strata_data_values = data[[default_disaggregation]])

sensitivity_test_table %>% kable(escape = FALSE) %>% kable_styling()


```

The overall index changes more than 0.5 points when removing the indicators for _drinking water source_ (WASH), _child marriage to reduce economic burden_ (Capacity Gaps) and _water access quantity_ (WASH). In the composite index, these indicators were consiously selected to have strong impact. As such, it is expected that their removal would have a strong impact on the results.

The index is robust towards all other indicators within the threshold of 0.5 points on the scale.



```{r mosaic plot}



# Example of how the formula is built
# 
#     weight = 1
#     x = product(Y, X)
#     fill = W
#     conds = product(Z)
# 
# These aesthetics set up the formula for the distribution:
# 
#     Formula: 1 ~ W + X + Y | Z

stratum_tibble<-tibble(stratum=assessment$data[[default_disaggregation]])
colnames(stratum_tibble)<-default_disaggregation
msni_varied_and_original<-c(msni_varied,
                            msni_original,
                            stratum_tibble) %>% as_tibble

msni_varied_and_original<-gather_(msni_varied_and_original,key = "key",value = 'value',gather_cols = names(msni_varied_and_original)[!(names(msni_varied_and_original) %in% c("msni",default_disaggregation))])
msni_varied_and_original$weights<-weighting(msni_varied_and_original)
msni_varied_and_original$value<-round(msni_varied_and_original$value,2)
msni_varied_and_original<-msni_varied_and_original[!is.na(msni_varied_and_original),]
ggplot(msni_varied_and_original)+
  geom_mosaic(aes(weight=weights,
                  x=product(msni,value),fill = (msni)))+scale_fill_brewer(name = "actual MSNI score")+theme_minimal()+theme(axis.text.y = element_blank())+xlab("MSNI score with one indicator removed")+ylab("")

```

### Sensitivity to Thresholds

The methodology relies heavily on normative judgement from sector as well is inter-sectoral experts.
As such, it needs to be robust with regards to variations in those judgements.
We add random noise of varying strength to the expert decision of how the indicators are combined, and compare the results to the original msni needs score.



```{r}
# create variations and calculate msni
msni_varied_indicators<-msni_variations(combination_tables, 
                                        assessment$severity,
                                        variation_function = vary_combination_tables_thresholds)

```


[[interpretation]]


```{r}

# t-test: differences smaller 0.5 on average?

# new dataframe: differences & stratum 

msni_original<- tibble(msni = assessment$data$msni)


sensitivity_test_table<- sensitivity_variation_test_result_table(msni_original = msni_original,
                                        msni_varied = msni_varied_indicators,
                                        threshold = 0.5,
                                        strata_data_name = default_disaggregation,
                                        strata_data_values = data[[default_disaggregation]])

sensitivity_test_table %>% kable(escape = FALSE) %>% kable_styling()


```




```{r mosaic plot}



# Example of how the formula is built
# 
#     weight = 1
#     x = product(Y, X)
#     fill = W
#     conds = product(Z)
# 
# These aesthetics set up the formula for the distribution:
# 
#     Formula: 1 ~ W + X + Y | Z

stratum_tibble<-tibble(stratum=assessment$data[[default_disaggregation]])
colnames(stratum_tibble)<-default_disaggregation
msni_varied_and_original<-c(msni_varied,
                            msni_original,
                            stratum_tibble) %>% as_tibble

msni_varied_and_original<-gather_(msni_varied_and_original,key = "key",value = 'value',gather_cols = names(msni_varied_and_original)[!(names(msni_varied_and_original) %in% c("msni",default_disaggregation))])
msni_varied_and_original$weights<-weighting(msni_varied_and_original)
msni_varied_and_original$value<-round(msni_varied_and_original$value,2)
msni_varied_and_original<-msni_varied_and_original[!is.na(msni_varied_and_original),]
ggplot(msni_varied_and_original)+
  geom_mosaic(aes(weight=weights,
                  x=product(msni,value),fill = (msni)))+scale_fill_brewer(name = "actual MSNI score")+theme_minimal()+theme(axis.text.y = element_blank())+xlab("MSNI score with one indicator removed")+ylab("")

```

```
## Conclusion



