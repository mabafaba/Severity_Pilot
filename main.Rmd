---
title: "pilot"
author: "REACH BGD"
date: "2 July 2019"
output:
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE, warning = FALSE, message=FALSE}

group<-c("host","refugee")[2]

knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warning = FALSE)
library(dplyr)
library(hypegrammaR)
library(kableExtra)
library(msni19)
library(glue)

source("functions/utilities.R")
source("functions/loading_inputs.R")
source("functions/severity_recoding_from_combination_table.R")
source("functions/severity_recoding_host.R")
source("functions/severity_recoding_refugee.R")
source("functions/plots.R")

#'  READ INPUT FILES

assessment<-msna18_severity_pilot_load_assessment(group)

if(group=="host") severity_compositions <- host_severity_bgd_msna18
if(group == "refugee") severity_compositions <- refugee_severity_bgd_msna18


assessment$data %<>% remove_non_consent

assessment$severity <- severity_compositions(hh  = assessment$data,
                                             ind = assessment$loops$individuals)

# impact & capacity score guessed
assessment$severity$impact <- 4

# msni not existent yet so randomising
assessment$data$msni<-with(assessment$severity,{
  msni19::msni(education_lsg = edu, 
               fsl_lsg = fsl, 
               health_lsg = health,
               protection_lsg = protection,
               wash_lsg = wash,
               shelter_lsg = nfi,
               impact = impact,
               capacity_gaps = capacity)
})


# everything below happening inside "assessment", so attaching for brevity:
attach(assessment)


  
```



# Severity Scoring Pilot `r ifelse(group=="host","Host Community", "Refugees")`

## Summary

### Results by Union

Distribution of severity:

```{r,fig.height = 20,fig.width = 5}

faceted_density_plot(assessment$data,
                     x_variable_name = "msni",
                     default_disaggregation)

```

The estimated severity in the host community:





```{r}
type_of_analysis<-map_to_case("group_difference",
                  dependent.var.type = "categorical",
                  independent.var.type = "categorical")


severity_disaggregated <- map_to_result(data,dependent.var = "msni",
                                        independent.var = default_disaggregation,
                                        case = type_of_analysis,
                                        weighting = weighting)

severity_disaggregated %>%
  map_to_labeled(questionnaire) %>% 
  map_to_table %>% kable %>% kable_styling()

```


```{r}

severity_disaggregated %>%
  map_to_labeled(questionnaire) %>% 
  map_to_visualisation %>% .$ggplot


```

### Distribution - How 'varied' are the scores?
```{r}
design<-map_to_design(data,weighting_function =  weighting)
standard_deviation <- sqrt(survey::svyvar(~msni,design)[1])
```
The overall standard deviation was <b> `r standard_deviation` </b>

```{r}
ecdf <- weighted_ecdf(data$msni, weighting(data))

ggplot(ecdf, aes(x, cum.pct)) +
  geom_line() + 
  theme_minimal() + 
  ylab("Cummulative probability") + 
  xlab("Score")

```

## Results

## Methodology


## Sensitivity and Robustness

Missing values in composite indicators
```{r}

percent_na_sev<-severity[,-1] %>% lapply(percent_na) %>% unlist
data.frame(`composite variable` = names(severity[,-1]),
           `percent NA` = percent_na_sev,
           check.names = FALSE) %>%
  kable %>%
  kable_styling()
```

## Conclusion



