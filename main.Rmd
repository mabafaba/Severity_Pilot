---
title: "pilot"
author: "REACH BGD"
date: "2 July 2019"
output:
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE, warning = FALSE, message=FALSE}

group<-c("host","refugee")[2]

knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warning = FALSE)
library(dplyr)
library(hypegrammaR)
library(kableExtra)
library(msni19)
library(glue)
library(ggmosaic)

source("functions/utilities.R")
source("functions/loading_inputs.R")
source("functions/severity_recoding_from_combination_table.R")
source("functions/severity_recoding_host.R")
source("functions/severity_recoding_refugee.R")
source("functions/plots.R")
source("./functions/sensitivity_utilities.R")
source("./functions/sensitivity_indicator_inclusion.R")

#  READ INPUT FILES

assessment<-msna18_severity_pilot_load_assessment(group)

if(group=="host") severity_compositions <- host_severity_bgd_msna18
if(group == "refugee") severity_compositions <- refugee_severity_bgd_msna18


assessment$data %<>% remove_non_consent

assessment$severity <- severity_compositions(hh  = assessment$data,
                                             ind = assessment$loops$individuals)


combination_tables<-read_all_csvs("./input_public/threshold_definitions/refugees/")
subpillar_scores <- subpillar_scores_bgd(list_of_combination_tables = combination_tables,
                                                       data = assessment$severity)


msni_varied<-msni_variations(combination_tables, assessment$severity)

assessment$severity <- c(assessment$severity,subpillar_scores) %>% as_tibble

# impact & capacity score guessed
assessment$severity$impact <- 4

# msni not existent yet so randomising
assessment$data$msni<-with(assessment$severity,{
  msni19::msni(education_lsg = edu, 
               fsl_lsg = fsl, 
               health_lsg = health,
               protection_lsg = protection,
               wash_lsg = wash,
               shelter_lsg = nfi,
               impact = impact,
               capacity_gaps = capacity)
})


# everything below happening inside "assessment", so attaching for brevity:
attach(assessment)


  
```



# Severity Scoring Pilot `r ifelse(group=="host","Host Community", "Refugees")`

## Summary

### Results by Union

Distribution of severity:

```{r,fig.height = 20,fig.width = 5}

faceted_density_plot(assessment$data,
                     x_variable_name = "msni",
                     default_disaggregation)

```

The estimated severity in the host community:





```{r}
type_of_analysis<-map_to_case("group_difference",
                  dependent.var.type = "categorical",
                  independent.var.type = "categorical")


severity_disaggregated <- map_to_result(data,dependent.var = "msni",
                                        independent.var = default_disaggregation,
                                        case = type_of_analysis,
                                        weighting = weighting)

severity_disaggregated %>%
  map_to_labeled(questionnaire) %>% 
  map_to_table %>% kable %>% kable_styling()

```


```{r}

severity_disaggregated %>%
  map_to_labeled(questionnaire) %>% 
  map_to_visualisation %>% .$ggplot


```

### Distribution - How 'varied' are the scores?
```{r}
design<-map_to_design(data,weighting_function =  weighting)
standard_deviation <- sqrt(survey::svyvar(~msni,design)[1])
```
The overall standard deviation was <b> `r standard_deviation` </b>

```{r}
ecdf <- weighted_ecdf(data$msni, weighting(data))

ggplot(ecdf, aes(x, cum.pct)) +
  geom_line() + 
  theme_minimal() + 
  ylab("Cummulative probability") + 
  xlab("Score")

```

## Results

## Methodology


## Sensitivity and Robustness

Missing values in composite indicators
```{r}

percent_na_sev<-severity[,-1] %>% lapply(percent_na) %>% unlist
data.frame(`composite variable` = names(severity[,-1]),
           `percent NA` = percent_na_sev,
           check.names = FALSE) %>%
  kable %>%
  kable_styling()
```


### Sensitivity to Included Indicators

```{r}

# t-test: differences smaller 0.5 on average?

# new dataframe: differences & stratum 
msni_original<- tibble(msni = assessment$data$msni)
msni_diffs <- msni_varied %>% purrr::map(function(x){abs(x-msni_original)-0.5}) %>% as_tibble
names(msni_diffs)<-paste0("diff",1:ncol(msni_diffs))
msni_diffs<- lapply(msni_diffs,unlist) %>% as.data.frame
msni_diffs$camp_location<-assessment$data$camp_location


# make survey design object
design<-map_to_design(msni_diffs,
                      weighting_function = weighting)

# define test formulas:
test_formulas<-sapply(paste0(names(msni_diffs),"~",0),formula)

# run tests:
tests<-lapply(test_formulas,svyttest,design = design)

# which variations have average <-0.5?
tests <- data.frame(sapply(tests,function(x){x$estimate}),sapply(tests,function(x){x$p.value}))
names(tests)<- c("distance from 0.5 difference","p")
tests$difference_smaller_05<-tests$`distance from 0.5 difference` < 0
tests$p_bonferroni_corrected<-tests$p*nrow(tests)
tests$dif_significantly_smaller_05<-tests$difference_smaller_05 & tests$p_bonferroni_corrected<0.01
tests$`average absolute difference`<-tests$`distance from 0.5 difference`+0.5
tests$`p value (Bonferroni corrected)`<-round(tests$p_bonferroni_corrected,5)
tests$`Difference signifcantly smaller 0.5`<-tests$dif_significantly_smaller_05 %>% as.character %>% recode("TRUE" = "Yes","FALSE" = "No")
tests %<>% arrange(dif_significantly_smaller_05,desc(`average absolute difference`))
tests %>% select(`average absolute difference`,`p value (Bonferroni corrected)`,`Difference signifcantly smaller 0.5`)
tests$`Difference signifcantly smaller 0.5`<- tests$`Difference signifcantly smaller 0.5` %>% cell_spec(background = ifelse(tests$`Difference signifcantly smaller 0.5`=="Yes","green","red"),color = "white")
tests %>% select(`average absolute difference`,`p value (Bonferroni corrected)`,`Difference signifcantly smaller 0.5`) %>% kable(escape = FALSE) %>% kable_styling()






```

```{r mosaic plot}



# Example of how the formula is built
# 
#     weight = 1
#     x = product(Y, X)
#     fill = W
#     conds = product(Z)
# 
# These aesthetics set up the formula for the distribution:
# 
#     Formula: 1 ~ W + X + Y | Z

msni_varied_and_original<-c(msni_varied,
                            msni_original,
                            tibble(camp_location=assessment$data$camp_location)) %>% as_tibble

msni_varied_and_original<-gather(msni_varied_and_original,key = "key",value = 'value',-msni,-camp_location)
msni_varied_and_original$weights<-weighting(msni_varied_and_original)
msni_varied_and_original$value<-round(msni_varied_and_original$value,2)

ggplot(msni_varied_and_original)+
  geom_mosaic(aes(weight=weights,
                  x=product(msni,value),fill = (msni)))+scale_fill_brewer(name = "actual MSNI score")+theme_minimal()+theme(axis.text.y = element_blank())+xlab("MSNI score with one indicator removed")+ylab("")

```
## Conclusion



